# 删除根目录以后

昨天在整理服务器的时候看见根目录下有个不需要的文件夹，想把它删掉但是没进去文件夹里面在根目录下就`rm -rf *`了

过了一秒种提示一些什么东西删不掉，一丝不安浮上心头，仔细一看，完蛋，`sudo rm -rf /`，真的被我执行了。

就像服毒的人告诉生者毒药的味道一样，这种经验一般都很宝贵。我把这种经历分享出来。

当我发现不对的时候赶紧`Ctrl C`，然后想看还剩下啥，结果`ls`命令没有了

我顿时慌了，身边同事听到我的一声我靠估计心也慌了。我强行镇定，看要怎么处理接下去的事情。

我查看了一下正在运行的服务，有些还能用，但是数据库相关接口都不能用了（因为`env`，`sh`等基本环境都没有了），现在肯定是不能重启，因为一旦重启估计启动不起来了。我发现我的当前会话还没有被踢出，虽然一些命令不能用但是`cd`和tab补全还可以，还有`history`这种shell指令还能用（然而没卵用）。借助tab补全我看了一下还剩的内容，根目录下文件夹按照asicII字典序被删除，首先是`/bin`，然后是`/boot`，然后是`/cdrom``/data``/etc``/home`，这些都没了。所以`busybox`和一些系统指令都没有了。这个服务器上跑的服务最主要是一个数据库，如果数据库的内容没有被删除，那么其他环境、代码都是很容易重新布置上去的。

我可以把数据库的数据拿到其他服务器上，但是没有`ssh-server`,这个操作显然做不了

或者我可以重新安一个`busybox`，然后把命令再一个个装回来再把数据拿出去。但是也没有`curl`、`apt-get`、`wget`等这些网络请求工具，估计也实现不了

我看了一眼阿里云的控制台，这个服务器并没有开启定时快照，这个数据库里存了运行快一年的上线app数据，很重要。丢了我就傻逼了。

我记得当时数据库是放在`/var`里，按照删除进度应该是还没有被删（这很重要，如果数据库数据被删掉了，那就比较麻烦了），不管怎样，赶紧在现在的基础上备份一下快照。

整理一下思路，现在这个磁盘里系统坏了，但是数据还在，那么可以将它挂载到另一个实例里，然后把里面的数据取出来。我觉得这个方案比较靠谱

然后提了一个加急工单，咨询一下阿里云的技术人员，有没有具体的这种方案

过了许久（相比平时已经快了很多了），得到一个肯定的答复：先把现在的磁盘保存快照，然后用同一个帐号在同一个可用区申请一个实例，可以按快照生成磁盘并将磁盘挂载上去（作为数据盘）

很好。这样就能把数据拿出来，但是要恢复之前这个实例必须要重置系统，然后花个2、3个小时重新搭建环境跑起程序，这对用户会有比较大的影响，所以我决定半夜再弄，现在用跑在内存里的服务再支撑一会儿。

再整理一下思路，其实我遇到的问题是：服务器系统坏了，数据还在，如何恢复的问题。

解决方案基本已经明确了，就是先把磁盘保存快照，然后在同一个可用区申请一个实例，把这个盘当数据盘mount上去，然后把原服务器重置，重新搭建环境导入数据和代码一跑就正常了。

快半夜的时候开始捣鼓，中间在恢复数据的时候遇到几个问题

1. mongodb关闭的时候锁没关需要删掉锁然后repair一下

2. 从别的服务器上直接把binary数据复制过来的话有用户归属权限的问题，需要`chown -R`改一下，

这两个问题都会导致mongod启动不起来

折腾到1点终于搞完了，顿时觉得自己每天都在经历大风大浪，如果每天都那么刺激我估计我要被刺激死了。

回头想一想，这件事情里的教训

1. 谨慎使用root用户操作服务器

2. 可以写个alias覆盖`rm`，把东西mv到某个`trash`目录下，然后定时删除

3. 用zsh执行`rm -rf *`的时候他会提示你，给你一个缓冲的机会，当然手快的这招也没用

4. 在根目录下建个`zzz`之类的文件夹，然后把要紧的东西全部硬链接`ln`到这个目录里面，因为万一删了但是及时停止可以重新链接回去。

5. 同理，数据库这种东西最好放在字典序后面的路径下（`var`/`zzz`之类的）里，如果在`/data`下，估计这次就救不回来了。。。

