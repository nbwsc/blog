# 如何在不同域名下共享信息

## 简略版
使用`iframe`在将父的任何js能访问到的信息共享给目标域名


## 完整版

事情的起因是因为阿里云oss的一个通知:

    出于安全考虑，从5月20日起，从互联网链路访问OSS国内各区域的网页类型文件的Response Headers中会自动加入Content-Disposition:'attachment=filename;'。 从浏览器访问网页类型文件，会以附件形式进行下载。
    用户使用自有域名访问OSS的请求，不会加入此Header

而我们的上线应用因为一些历史问题,就是用了阿里oss原来的域名.现在只能被迫做调整.

怎么从一个写死在代码里的域名改成能用的域名?而且这个域名和服务器没有掌握在我们的手里.我想了想有几个办法,一个是逻辑跳转,但是如果以附件形式下载html,js并不会被load,这种方式并不可行.另一个办法就是proxy,但是服务器不在我们手上,于是我找了下oss的bucket配置,发现可以配置重定向,实验了一下,应该是没问题.好这个问题解决了.随之而来有另外一个问题,就是改域名以后原域名下localStorage新域名下是访问不到的(同源策略).怎么让用户没有感知和操作下完成升级呢?

介绍一下背景:应用是一个跑在android盒子上的混合应用,使用原生java加嵌入crosswalk的方式,原生部分负责开机启动看门狗网络环境检查等任务,主体的应用逻辑和界面都用远端的js加载绘制,所以在不升级java的情况下,可以修改html和js部分,而用户信息也是存在crosswalk的localStorage中.

我想了几个办法

1. 通过浏览器访问本地资源
2. 调查浏览器有没有一块不限制源的离线存储空间
3. 区分浏览器

我发现,1方案可以通过download方式写入资源,但是无法读取,因为这种做法是跨越浏览器安全的.
我尝试过存成html用iframe去加载本地html不成功,
存成js或其他资源用script标签去加载,也不成功(因为浏览根本不会让你去访问本地资源).当然如果你能控制java部分是很容易很做的.
2方案很快也证实,没有这样的东西.
于是我想,如果把用户信息和浏览器进行绑定上传到服务器,新域名下根据浏览器去取得用户信息,应该也可以.但是做了很多努力也是没有找到类似browser ID之类的东西.ip我很早就想过,不稳定会变,所以无法用ip去区分,而mac地址这种区分设备的信息通过浏览器是更加拿不到的.执行能想其他办法.

今天想了一个很hack的方法:我现在要做的其实就是在新域名下写入当前能拿到的用户信息就可以.那么我可以在现在的页面里插入一个`iframe`,用新域名下的一个页面先写入localStorage中.
整个想法就是:在现有的html下藏一个iframe,iframe加载的就是新域名下做的一个localStorage Tansformer,什么意思呢,那个页面什么都不做,就是把参数写入到localStorage中,等以后重定向过去到新的域名以后就直接能访问到这些用户信息,一些不痛不痒得就该过来了.那么怎么传参数呢,我想了两种办法,一种用父级js调用子frame的js函数传参,另一种在src的url中加入参数,我选了后者,因为后者不需要考虑js的执行时间什么的,对现有应用影响最小.

另外有一些比较有用的小tip,或许可以用到

几个用html下载资源的方式

1. 使用`a`标签的`download`属性
```html
<a id='downloader' style="display:none;"\>
<script>
	function download(url,filename) {
		var d = document.getElementById('downloader');
		d.href = url;
		d.download = filename||'file'
		d.click()
	}
</script>
```

2. 使用`iframe`标签加载 target uri.当然如果目标不能是html这种能加载出来的东东